# 智能曲线合并功能使用指南

## ? 功能完成

已成功实现**自动合并相连曲线**功能！

---

## ?? 功能说明

### 问题

从 STEP 文件导入的曲线经常被分割成多个独立的小线段：
```
导入前（CAD 中）:     导入后（原来）:
┌────────────┐     ┌──┐┌──┐┌──┐┌──┐
│ 完整曲线    │  →    │ 1││ 2││ 3││ 4│  ← 被分成很多段
└────────────┘       └──┘└──┘└──┘└──┘
```

### 解决方案

新增**智能合并**功能，自动检测并合并首尾相连的曲线：
```
合并前:     合并后:
usv_01 ─┐            ┌─────────────┐
usv_02 ─┤  → │ merged_01   │  ← 自动合并
usv_03 ─┘            └─────────────┘
```

---

## ?? 使用方法

### 方式 1：工具栏按钮（推荐）

```
1. ?? 导入 STEP 文件
   ↓
2. ?? 点击"合并曲线"按钮
   ↓
3. ?? 查看检测结果
   - 显示可合并的曲线组
   - 显示合并预览
   ↓
4. ? 确认合并
   ↓
5. ?? 完成！
```

### 方式 2：菜单选项

```
菜单: 曲线 → 合并相连曲线 (Ctrl+M)
```

---

## ?? 合并流程示例

### 步骤 1: 导入 STEP 文件

```
? 导入成功！

导入了 66 条曲线:
  usv_01 (2 点)
  usv_02 (2 点)
  usv_03 (2 点)
  ...
  usv_66 (2 点)
```

### 步骤 2: 点击"合并曲线"

系统自动检测相连的曲线：
```
检测中...
- 检查曲线端点距离
- 识别连接关系
- 分组相连曲线
```

### 步骤 3: 查看检测结果

```
┌─────────────────────────────────┐
│ 检测到 8 组可合并的曲线:   │
│              │
│   组 1: usv_01, usv_02, usv_03, │
│usv_04, usv_05, usv_06, │
│         usv_07, usv_08 (8 条)   │
│       │
│组 2: usv_09, usv_10, usv_11  │
│     (3 条)         │
│                │
│   ...     │
│        │
│ 容差: 0.0100        │
│         │
│ 是否执行合并？                  │
│ (原始曲线将被删除)     │
│    │
│    [是(Y)]    [否(N)]        │
└─────────────────────────────────┘
```

### 步骤 4: 合并结果

```
? 合并成功！

原始曲线数: 66
合并后曲线数: 8
合并了 58 条曲线

新曲线列表:
  merged_01 (82 点) ← 由 8 条小线段合并
  merged_02 (45 点) ← 由 3 条小线段合并
  merged_03 (120 点)
  ...
```

---

## ?? 合并容差设置

### 什么是合并容差？

容差决定了多近的端点会被视为"相连"：

```
容差 = 0.01 (默认):
  
  曲线1末端 ●─────┐
  距离 0.005      │ < 0.01 → ? 相连，会合并
  曲线2起点 ●─────┘

曲线1末端 ●─────┐
  距离 0.05       │ > 0.01 → ? 不连，不合并
  曲线2起点 ●─────┘
```

### 调整容差

在左侧面板中调整：

```
┌──────────────────┐
│ 合并容差设置      │
│  │
│ ┌──────────────┐ │
│ │   0.0100  │ │ ← 输入新值
│ └──────────────┘ │
│ (默认: 0.0100)   │
└──────────────────┘
```

### 容差建议

| 模型类型 | 推荐容差 | 说明 |
|---------|---------|------|
| **精密模型** | 0.001 | 高精度，只合并非常接近的点 |
| **一般模型** | 0.01 | 默认值，适用于大多数情况 |
| **粗糙模型** | 0.1 | 较大容差，容忍更多误差 |

---

## ?? 合并算法

### 检测逻辑

系统会检查 4 种连接方式：

```
1. 末端到起点 (最常见):
   曲线1: ─────●
   曲线2:      ●─────

2. 末端到末端:
   曲线1: ─────●
   曲线2: ─────●

3. 起点到起点:
   曲线1: ●─────
   曲线2: ●─────

4. 起点到末端:
   曲线1: ●─────
   曲线2: ─────●
```

### 合并策略

```
连接类型     →    合并方式
─────────────────────────────
末端到起点   →    直接拼接
末端到末端   →    反转后拼接
起点到起点   →    反转插入前面
起点到末端   →    直接插入前面
```

### 迭代合并

系统会持续查找可连接的曲线，直到没有更多可合并的：

```
第 1 轮:  A─B  C─D  E─F
            ↓  合并
第 2 轮:  A─B─C─D  E─F
      ↓  合并
第 3 轮:  A─B─C─D─E─F
       ↓  完成
结果:    一条完整曲线
```

---

## ?? 实际使用案例

### 案例 1: 船体线框导入

**问题**:
```
从 STEP 导入船体线框
- 32 条横剖线
- 每条线被分成 8 段
- 总共 256 个小线段
```

**解决**:
```
1. 导入 STEP → 256 条曲线
2. 点击"合并曲线"
3. 检测到 32 组（每组 8 条）
4. 合并后 → 32 条完整曲线 ?
```

### 案例 2: 多段连续曲线

**问题**:
```
导入的曲线:
LINE_01 (2 点)
LINE_02 (2 点)
LINE_03 (2 点)
...
LINE_32 (2 点)

所有线段首尾相连，应该是一条曲线
```

**解决**:
```
1. 导入后有 32 条短线段
2. 合并曲线
3. 结果：1 条长曲线 (64 点) ?
```

### 案例 3: 混合情况

**问题**:
```
- 有些曲线相连
- 有些曲线独立
- 不确定哪些该合并
```

**解决**:
```
1. 点击"合并曲线"
2. 系统自动检测:
   - 组 1: 曲线 A, B, C (相连)
   - 组 2: 曲线 E, F (相连)
   - 曲线 D 独立（不合并）
   - 曲线 G 独立（不合并）
3. 只合并检测到的组 ?
```

---

## ?? 使用技巧

### 技巧 1: 先检查再合并

```
合并是不可逆操作！

建议:
1. 先查看检测结果
2. 确认合并的组是否正确
3. 检查容差是否合适
4. 再确认执行
```

### 技巧 2: 调整容差

```
如果检测结果不理想:

情况 1: 太多曲线被合并
→ 减小容差 (如 0.01 → 0.001)

情况 2: 应该合并的没有合并
→ 增大容差 (如 0.01 → 0.1)
```

### 技巧 3: 导出前保存

```
推荐工作流:

1. 导入 STEP
2. 【保存项目】← 重要！
3. 合并曲线
4. 如果不满意 → 重新导入
5. 满意后继续操作
```

### 技巧 4: 分批合并

```
如果文件很大:

1. 导入所有曲线
2. 删除不需要的曲线
3. 只保留需要合并的
4. 执行合并
5. 重复步骤 1-4 处理其他部分
```

---

## ?? 调试输出

### 查看详细信息

在 Visual Studio 输出窗口可以看到详细的合并过程：

```
========== 开始合并曲线 ==========
输入曲线数: 66
连接容差: 0.01

开始合并组，起始曲线: 0
  连接曲线 1，连接类型: EndToStart，当前点数: 4
  连接曲线 2，连接类型: EndToStart，当前点数: 6
  连接曲线 3，连接类型: EndToStart，当前点数: 8
  ...
合并组完成，包含曲线: [0, 1, 2, 3, 4, 5, 6, 7]，总点数: 16

开始合并组，起始曲线: 8
  连接曲线 9，连接类型: EndToStart，当前点数: 4
  ...

========== 合并完成 ==========
原始曲线数: 66
合并后曲线数: 8
合并了 58 条曲线
```

---

## ?? 注意事项

### 1. 合并是不可逆的

```
?? 原始曲线会被删除！

建议:
- 合并前先保存项目
- 或导出 XML 备份
- 不确定时先不合并
```

### 2. 合并后需重新命名

```
合并后曲线名称:
merged_01
merged_02
...

建议:
- 合并后点击"自动命名"
- 或手动重命名
```

### 3. 容差影响结果

```
容差太小 → 可能漏掉应该合并的
容差太大 → 可能错误合并不相连的

建议:
- 先用默认值 (0.01) 尝试
- 根据结果调整
```

### 4. 性能考虑

```
曲线数量    合并时间
< 100      < 1 秒
100-500    1-5 秒
> 500      可能较慢

建议:
- 大文件分批处理
- 先删除不需要的曲线
```

---

## ?? 总结

### 主要优势

? **自动化**
- 无需手动选择
- 智能检测相连关系
- 一键完成合并

? **智能**
- 4 种连接方式检测
- 迭代式合并
- 可配置容差

? **可靠**
- 详细的合并预览
- 清晰的结果反馈
- 完整的调试信息

? **高效**
- 快速处理大量曲线
- 大幅减少手动工作
- 提高后续操作效率

---

## ?? 工作流程建议

### 标准流程

```
1. ?? 导入 STEP 文件
   ↓
2. ?? 检查导入的曲线
   - 数量
   - 命名
   - 结构
   ↓
3. ?? 合并相连曲线
   - 查看检测结果
   - 调整容差（如需要）
   - 确认合并
   ↓
4. ??? 自动命名
   ↓
5. ?? 放样曲线
   ↓
6. ?? 生成步骤
   ↓
7. ?? 导出 XML
```

---

**现在您可以轻松合并分散的线段，构建完整的曲线了！** ??

需要帮助？查看调试输出或调整合并容差。
