# 技术栈说明

## 概述

本文档详细说明了 3D 路径编辑器使用的技术栈、框架和依赖库。

---

## ?? 核心技术

### .NET 8

**版本**: .NET 8.0  
**目标框架**: `net8.0-windows`

**选择原因**:
- 最新的长期支持版本（LTS）
- 性能优化和改进
- C# 12 语言特性支持
- 原生 AOT 支持

**关键特性**:
- Record types
- Pattern matching enhancements
- Nullable reference types
- Init-only properties

---

## ??? UI 框架

### WPF (Windows Presentation Foundation)

**版本**: .NET 8 内置  
**用途**: 桌面应用程序界面

**特性**:
- XAML 声明式 UI
- 强大的数据绑定
- 样式和模板系统
- 矢量图形和动画

**使用的控件**:
- `TreeView` - 步骤树形结构
- `DataGrid` - USV 数据表格
- `Menu` / `ToolBar` - 菜单和工具栏
- `Expander` - 可折叠面板
- `Slider` - 滑块控件

---

## ?? 3D 图形

### HelixToolkit.Wpf

**版本**: 2.22.0  
**官网**: [https://github.com/helix-toolkit/helix-toolkit](https://github.com/helix-toolkit/helix-toolkit)

**用途**: 3D 可视化和渲染

**核心组件**:
- `HelixViewport3D` - 3D 视口
- `SphereVisual3D` - 球体可视化
- `LinesVisual3D` - 线条可视化
- `ArrowVisual3D` - 箭头可视化
- `BillboardTextVisual3D` - 3D 文本标签

**特点**:
- 基于 WPF 3D
- 易于集成
- 丰富的 3D 元素
- 相机控制

**注意事项**:
- 基于 .NET Framework 开发
- 在 .NET 8 中使用会有兼容性警告（NU1701）
- 功能正常，可以忽略警告

---

## ??? MVVM 框架

### CommunityToolkit.Mvvm

**版本**: 8.4.0  
**官网**: [Microsoft Community Toolkit](https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/)

**用途**: MVVM 模式实现

**使用的功能**:
- `ObservableObject` - 属性变更通知
- `RelayCommand` - 命令实现
- `ObservableProperty` - 属性生成器
- Source Generators - 代码生成

**优势**:
- 减少样板代码
- 类型安全
- 性能优化
- 官方维护

---

## ?? 依赖注入

### Microsoft.Extensions.DependencyInjection

**版本**: 8.0.0  
**官网**: [Microsoft Docs](https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection)

**用途**: 依赖注入容器

**服务生命周期**:
- `Singleton` - 单例服务
  - `IPathDataService`
  - `IDialogService`
- `Transient` - 瞬时服务
  - `MainViewModel`
  - `MainWindow`

**配置示例**:
```csharp
services.AddSingleton<IPathDataService, XmlPathDataService>();
services.AddTransient<MainViewModel>();
```

---

## ?? NuGet 包

### 完整依赖列表

```xml
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
<PackageReference Include="HelixToolkit.Wpf" Version="2.22.0" />
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.0" />
```

### 版本兼容性

| 包名 | 版本 | 目标框架 | 兼容性 |
|------|------|----------|--------|
| CommunityToolkit.Mvvm | 8.4.0 | .NET 8 | ? 完全兼容 |
| HelixToolkit.Wpf | 2.22.0 | .NET Framework 4.6.1+ | ?? 兼容但有警告 |
| Microsoft.Extensions.DI | 8.0.0 | .NET 8 | ? 完全兼容 |

---

## ??? 开发工具

### IDE

**Visual Studio 2022**
- 版本: 17.8+
- 工作负载:
  - .NET 桌面开发
  - .NET 8 SDK

**VS Code** (可选)
- C# Dev Kit 扩展
- .NET Runtime 扩展

### 构建工具

**MSBuild**
- 版本: 17.0+
- .NET 8 SDK

### 版本控制

**Git**
- 分支策略: Main
- 远程仓库: GitHub

---

## ?? 项目配置

### Path.csproj 关键设置

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <!-- 目标框架 -->
    <TargetFramework>net8.0-windows</TargetFramework>
    
    <!-- 启用 WPF -->
    <UseWPF>true</UseWPF>
    
    <!-- C# 语言版本 -->
    <LangVersion>12.0</LangVersion>
    
    <!-- 可空引用类型 -->
    <Nullable>enable</Nullable>
    
    <!-- 隐式 Using -->
    <ImplicitUsings>enable</ImplicitUsings>
    
    <!-- 输出类型 -->
    <OutputType>WinExe</OutputType>
  </PropertyGroup>
</Project>
```

### 隐式 Using

由于启用了 `ImplicitUsings`，以下命名空间自动引入：

```csharp
// 自动引入（无需手动 using）
System
System.Collections.Generic
System.Linq
System.Threading.Tasks
```

对于 WPF 项目额外引入：
```csharp
System.Windows
System.Windows.Controls
System.Windows.Data
System.Windows.Media
```

---

## ?? C# 12 特性使用

### Record Types

```csharp
public record SegmentDto(
    int Index, 
    List<Point3D> ControlPoints, 
    bool IsArc = false, 
 List<Point3D>? Samples = null
);
```

### Pattern Matching

```csharp
if (seg is { ControlPoints.Count: >= 3 } && seg.IsArc)
{
    // 处理圆弧
}
```

### Nullable Reference Types

```csharp
public Action<Point3D>? OnPlaneClicked { get; set; }

private GeometryModel3D? _planeModel;
```

### Init-Only Properties

```csharp
public class UsvModel
{
    public string Id { get; init; }
    public double X { get; init; }
}
```

---

## ?? 安全性考虑

### 输入验证

```csharp
public double ExportScale 
{ 
  get => _exportScale; 
    set => _exportScale = Math.Max(1e-9, value); 
}
```

### 异常处理

```csharp
try 
{
    // 操作
}
catch (Exception ex)
{
    // 日志记录
    // 用户提示
}
```

---

## ?? 性能优化

### 使用的优化技术

1. **ObservableCollection** - 集合变更通知
2. **Lazy Loading** - 延迟加载
3. **Async/Await** - 异步操作
4. **Partial Class** - 代码分离
5. **Source Generators** - 编译时代码生成

### 3D 渲染优化

- 使用简单几何体（Sphere, Lines）
- 控制顶点数量
- 合理使用视觉缩放（_visualScale = 0.1）
- 延迟刷新（RefreshUsvData）

---

## ?? 数据格式

### XML 格式

```xml
<?xml version="1.0"?>
<PathData>
  <Steps>
    <Step Number="1">
      <Usvs>
        <Usv Id="USV1">
          <X>100.0</X>
          <Y>200.0</Y>
          <Z>0.0</Z>
   <Yaw>0.0</Yaw>
  <Speed>1.5</Speed>
    </Usv>
      </Usvs>
 </Step>
  </Steps>
</PathData>
```

### 内部数据结构

```csharp
List<StepModel>
 └── ObservableCollection<UsvModel>
```

---

## ?? 跨平台考虑

### 当前限制

- **平台**: Windows Only
- **原因**: WPF 是 Windows 专有技术
- **替代方案**: 
  - Avalonia UI (跨平台 XAML)
  - .NET MAUI (移动端)

### 未来可能性

如需跨平台支持，可考虑:
1. 将业务逻辑提取到 .NET Standard 库
2. UI 层使用 Avalonia 或 MAUI 重写
3. 3D 渲染使用 Silk.NET 或 Veldrid

---

## ?? 学习资源

### 官方文档

- [.NET 8 文档](https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8)
- [WPF 文档](https://learn.microsoft.com/en-us/dotnet/desktop/wpf/)
- [HelixToolkit 文档](https://github.com/helix-toolkit/helix-toolkit/wiki)
- [MVVM Toolkit 文档](https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/)

### 推荐阅读

- 《WPF 编程宝典》
- 《深入理解 C#》
- Microsoft Patterns & Practices

---

## ?? 故障排除

### 常见问题

**问题 1**: NU1701 警告（HelixToolkit 兼容性）

**解决方案**: 
```xml
<PropertyGroup>
  <NoWarn>NU1701</NoWarn>
</PropertyGroup>
```

**问题 2**: 3D 渲染性能问题

**解决方案**:
- 减少控制点数量
- 使用更大的采样间隔
- 禁用自动缩放

**问题 3**: 数据绑定不更新

**解决方案**:
- 确保实现 `INotifyPropertyChanged`
- 使用 `ObservableCollection`
- 检查 `DataContext` 设置

---

## ?? 最佳实践

1. **使用依赖注入** - 提高可测试性
2. **遵循 MVVM 模式** - 分离关注点
3. **启用 Nullable** - 减少空引用错误
4. **使用 Record Types** - 不可变数据
5. **异步操作** - 避免 UI 阻塞
6. **资源释放** - 实现 IDisposable

---

**版本**: 1.0  
**最后更新**: 2024-12-22  
**维护者**: 项目团队
