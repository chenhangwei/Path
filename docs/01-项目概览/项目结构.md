# 项目结构说明

## 概述

本文档详细说明了 3D 路径编辑器项目的文件组织结构和各模块职责。

---

## ?? 目录结构

```
Path/
├── .github/       # GitHub 配置
│   └── copilot-instructions.md # Copilot 编码规范
│
├── docs/             # 文档目录
│   ├── 01-项目概览/           # 项目基本信息
│   ├── 02-开发指南/      # 开发相关文档
│   ├── 03-用户手册/     # 用户使用手册
│   └── 04-维护日志/      # 变更和维护记录
│
├── Models/      # 数据模型
│   ├── StepModel.cs         # 步骤数据模型
│   └── UsvModel.cs          # USV 数据模型
│
├── ViewModels/        # 视图模型（MVVM）
│   └── MainViewModel.cs       # 主窗口视图模型
│
├── Views/           # 用户界面视图
│   ├── PathEditor3D.xaml# 3D 编辑器界面
│   ├── PathEditor3D.xaml.cs   # 3D 编辑器代码
│   ├── PathEditor3D.Snap.cs   # 3D 编辑器捕捉功能（partial）
│   └── PathEditor3D.Size.cs   # 3D 编辑器大小功能（partial）
│
├── Services/       # 服务层
│   ├── IDialogService.cs      # 对话框服务接口
│   ├── IPathDataService.cs    # 路径数据服务接口
│   ├── WpfDialogService.cs    # WPF 对话框实现
│   └── XmlPathDataService.cs  # XML 数据持久化服务
│
├── Helpers/        # 辅助工具类
│ └── RelayCommand.cs        # MVVM 命令辅助类
│
├── App.xaml   # 应用程序定义
├── App.xaml.cs          # 应用程序代码
├── MainWindow.xaml     # 主窗口界面
├── MainWindow.xaml.cs         # 主窗口代码
├── Path.csproj                # 项目文件
└── README.md    # 项目说明
```

---

## ??? 架构设计

### MVVM 架构

项目采用标准的 MVVM（Model-View-ViewModel）架构：

```
┌─────────────┐   ┌──────────────┐       ┌─────────────┐
│    View     │?────────│  ViewModel   │?────────│    Model│
│   (XAML)    │ Binding │   (Logic)    │  Uses   │   (Data)    │
└─────────────┘         └──────────────┘         └─────────────┘
       │   │       │
       │     │           │
       │   ┌──────────┐    │
       │     │  Services │?────────────────┘
       │└───────────┘
       │
       └──────────────? User Interaction
```

**职责划分**：

- **Model**: 纯数据模型，不包含业务逻辑
  - `StepModel.cs`: 步骤数据
  - `UsvModel.cs`: USV 路径点数据

- **ViewModel**: 业务逻辑和状态管理
  - `MainViewModel.cs`: 主界面逻辑
  - 实现 `INotifyPropertyChanged`
  - 使用 `RelayCommand` 处理命令

- **View**: 用户界面
  - `MainWindow.xaml`: 主窗口布局
  - `PathEditor3D.xaml`: 3D 编辑器界面
  - 通过数据绑定连接 ViewModel

- **Services**: 跨层服务
  - `IPathDataService`: 数据持久化
  - `IDialogService`: 用户交互

---

## ?? 核心模块

### 1. 3D 编辑器 (PathEditor3D)

**文件**:
- `PathEditor3D.xaml.cs` - 主逻辑
- `PathEditor3D.Snap.cs` - 智能捕捉功能
- `PathEditor3D.Size.cs` - 大小和缩放功能

**功能**:
- 3D 路径可视化
- UG NX 风格的相机控制
- 智能捕捉（网格/点/中点/投影）
- 实时数据刷新
- 控制点编辑

**技术**:
- HelixToolkit.Wpf 2.22.0
- Partial Class 分离功能
- 事件驱动架构

### 2. 数据模型 (Models)

**StepModel**:
```csharp
public class StepModel
{
    public int Number { get; set; }
    public ObservableCollection<UsvModel> Usvs { get; set; }
    public string DisplayName => $"Step {Number}";
}
```

**UsvModel**:
```csharp
public class UsvModel
{
    public string Id { get; set; }
    public double X { get; set; }
    public double Y { get; set; }
    public double Z { get; set; }
    public double Yaw { get; set; }
    public double Speed { get; set; }
}
```

### 3. 服务层 (Services)

**数据服务**:
- `IPathDataService` - 接口定义
- `XmlPathDataService` - XML 实现
- 支持导入/导出 XML 格式

**对话框服务**:
- `IDialogService` - 接口定义
- `WpfDialogService` - WPF 实现
- 文件选择、消息框等

### 4. 视图模型 (ViewModels)

**MainViewModel**:
- 管理步骤列表
- 处理用户命令
- 协调 View 和 Services
- 状态消息管理

**命令**:
- `ImportXmlCommand` - 导入数据
- `ExportXmlCommand` - 导出数据
- `AddStepCommand` - 添加步骤
- `RemoveStepCommand` - 删除步骤
- `AddUsvCommand` - 添加 USV

---

## ?? 依赖注入

使用 `Microsoft.Extensions.DependencyInjection` 管理依赖：

```csharp
// App.xaml.cs
private void ConfigureServices(IServiceCollection services)
{
    // 注册服务
    services.AddSingleton<IPathDataService, XmlPathDataService>();
    services.AddSingleton<IDialogService, WpfDialogService>();

    // 注册 ViewModels
    services.AddTransient<MainViewModel>();

    // 注册 Windows
    services.AddTransient<MainWindow>();
}
```

**优势**:
- 松耦合
- 易于测试
- 便于扩展

---

## ?? UI 组件层次

```
MainWindow
├── Menu Bar            # 菜单栏
├── Tool Bar# 工具栏
├── Status Bar            # 状态栏
└── Grid (3 columns)
    ├── TreeView               # 步骤树（左侧）
    ├── DataGrid # USV 数据表（中间）
    └── PathEditor3D        # 3D 编辑器（右侧）
    ├── Expander           # 设置面板
│   ├── Slider         # 控制点大小
      │   └── CheckBox       # 自动缩放
      └── HelixViewport3D    # 3D 视图
```

---

## ?? 配置文件

### Path.csproj

关键配置:
```xml
<TargetFramework>net8.0-windows</TargetFramework>
<UseWPF>true</UseWPF>
<Nullable>enable</Nullable>
<ImplicitUsings>enable</ImplicitUsings>
```

依赖包:
- `HelixToolkit.Wpf` 2.22.0
- `CommunityToolkit.Mvvm` 8.4.0
- `Microsoft.Extensions.DependencyInjection` 8.0.0

---

## ?? 设计模式

### 使用的模式

1. **MVVM Pattern** - 整体架构
2. **Command Pattern** - 用户操作
3. **Observer Pattern** - 数据绑定
4. **Dependency Injection** - 依赖管理
5. **Service Locator** - 服务获取
6. **Partial Class** - 代码组织

---

## ?? 扩展点

### 添加新功能

1. **新的编辑功能**:
   - 在 `PathEditor3D` 中添加新的 partial class
   - 实现相关方法和事件处理

2. **新的数据源**:
   - 实现 `IPathDataService` 接口
   - 在 DI 容器中注册

3. **新的对话框**:
   - 扩展 `IDialogService` 接口
   - 在 `WpfDialogService` 中实现

---

## ?? 数据流

```
用户操作
   │
   
MainWindow (View)
   │
   
MainViewModel (ViewModel)
   │
   ├──? PathDataService (数据持久化)
   │
   └──? PathEditor3D (3D 可视化)
        │
      ├──? 更新 3D 场景
   │
      └──? 触发回调事件
      │
             
    更新 ViewModel 状态
```

---

## ?? 代码组织原则

1. **单一职责**: 每个类只负责一项功能
2. **开闭原则**: 对扩展开放，对修改封闭
3. **依赖倒置**: 依赖抽象而非具体实现
4. **接口隔离**: 接口最小化
5. **Partial Class**: 按功能分离大类

---

## ?? 命名约定

- **类名**: PascalCase (`MainViewModel`)
- **方法**: PascalCase (`LoadData()`)
- **私有字段**: _camelCase (`_viewModel`)
- **属性**: PascalCase (`SelectedStep`)
- **事件**: PascalCase (`OnDataLoaded`)
- **接口**: I + PascalCase (`IPathDataService`)

---

## ?? 相关文档

- [技术栈说明](./技术栈.md)
- [编码规范](../../.github/copilot-instructions.md)
- [3D编辑器实现](../02-开发指南/功能实现/3D编辑器迁移指南.md)

---

**版本**: 1.0  
**最后更新**: 2024-12-22  
**维护者**: 项目团队
