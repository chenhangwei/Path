# 步骤高亮功能实现指南

## ?? 功能需求

当用户在步骤列表（TreeView）中选择某个 Step 后，在 3D 视图中：
1. **显示 USV 编号标签** - 为该步骤中的每个 USV 显示其 ID 标签
2. **"点亮"（高亮）控制点** - 高亮显示该步骤中所有 USV 的控制点

---

## ?? 当前状态

**问题**: `Views/PathEditor3D.xaml.cs` 文件在编辑过程中被破坏，导致编译失败。

**错误**: 文件结构不完整，缺少以下方法：
- `HelixView_MouseWheel`
- `HelixView_PreviewMouseDown`
- `HelixView_PreviewMouseMove`
- `HelixView_PreviewMouseUp`
- `UpdateGridFill`
- `HideGizmo`
- `GetSceneCenter`

**建议**:
1. 从版本控制恢复 `Views/PathEditor3D.xaml.cs`
2. 或提供完整的 PathEditor3D.xaml.cs 文件
3. 然后再添加步骤高亮功能

---

## ? 已完成的部分

### 1. MainWindow.xaml.cs

已添加步骤选择时的高亮调用：

```csharp
// ViewModel 属性改变处理
private void ViewModel_PropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
{
    // 当选中的步骤改变时，刷新 3D 视图
    if (e.PropertyName == nameof(MainViewModel.SelectedStep))
    {
        RefreshPathEditor3D();
 
        // ? 高亮显示选中的步骤
    try
        {
       var pathEditor3D = FindName("PathEditor3DControl") as PathEditor3D;
     if (pathEditor3D != null && _viewModel.SelectedStep != null)
            {
        var usvIds = _viewModel.SelectedStep.Usvs.Select(u => u.Id).ToList();
         pathEditor3D.HighlightStep(_viewModel.SelectedStep.Number, usvIds);
            }
   else if (pathEditor3D != null)
   {
     pathEditor3D.ClearStepHighlight();
         }
        }
  catch { }
    }
    
    // ...其他代码...
}

// TreeView选中项更改的事件处理程序
private void OnStepSelected(object sender, RoutedPropertyChangedEventArgs<object> e)
{
  // ...现有代码...
    
    // ? 高亮显示选中的步骤
    if (_viewModel.SelectedStep != null)
    {
   var usvIds = _viewModel.SelectedStep.Usvs.Select(u => u.Id).ToList();
  pathEditor3D.HighlightStep(_viewModel.SelectedStep.Number, usvIds);
    }
}
```

---

## ?? 待实现的功能

### 需要在 `PathEditor3D.xaml.cs` 中添加

#### 1. 字段定义

```csharp
// 高亮选中步骤的点和标签
private readonly List<BillboardTextVisual3D> _stepHighlightLabels = new();
private readonly List<SphereVisual3D> _stepHighlightSpheres = new();
```

#### 2. 高亮方法

```csharp
/// <summary>
/// 高亮显示选中步骤的 USV 点并显示标签
/// </summary>
/// <param name="stepNumber">步骤编号（从1开始）</param>
/// <param name="usvIds">该步骤中的 USV ID 列表</param>
public void HighlightStep(int stepNumber, List<string> usvIds)
{
    try
    {
        // 清除之前的高亮
        ClearStepHighlight();

      if (_lastUsvs == null || usvIds == null || usvIds.Count == 0)
       return;

        // 步骤编号转换为索引（从0开始）
     var stepIndex = stepNumber - 1;

        // 遍历所有 USV
        for (int ui = 0; ui < _lastUsvs.Count; ui++)
  {
            var usv = _lastUsvs[ui];
        
            // 检查是否是本步骤的 USV
 if (!usvIds.Contains(usv.Name))
       continue;

          var highlightColor = Colors.Yellow; // 高亮颜色

   // 遍历该 USV 的所有段
            foreach (var seg in usv.Segments)
      {
          // 检查步骤索引是否有效
        if (stepIndex < 0 || stepIndex >= seg.ControlPoints.Count)
      continue;

          // 获取该步骤对应的点
      var point = seg.ControlPoints[stepIndex];
       var visualCenter = LogicalToVisual(point);

      // 创建高亮球体（稍大且颜色不同）
          var highlightRadius = CalculatePointRadius(visualCenter, false) * 1.5;
          var highlightSphere = new SphereVisual3D
{
         Center = visualCenter,
           Radius = highlightRadius,
    Fill = new SolidColorBrush(highlightColor)
              };
    SceneRoot.Children.Add(highlightSphere);
        _stepHighlightSpheres.Add(highlightSphere);

       // 创建 USV ID 标签
      var label = new BillboardTextVisual3D
    {
        Text = usv.Name,
        Position = LabelPosition(visualCenter),
      Foreground = Brushes.Black,
         Background = new SolidColorBrush(Color.FromArgb(220, 255, 255, 0)), // 半透明黄色
     FontSize = 14,
       FontWeight = FontWeights.Bold
     };
       SceneRoot.Children.Add(label);
        _stepHighlightLabels.Add(label);
            }
        }
}
    catch (Exception ex)
    {
    System.Diagnostics.Debug.WriteLine($"高亮步骤失败: {ex.Message}");
    }
}
```

#### 3. 清除高亮方法

```csharp
/// <summary>
/// 清除步骤高亮
/// </summary>
public void ClearStepHighlight()
{
    try
    {
 // 移除所有高亮标签
        foreach (var label in _stepHighlightLabels)
        {
            SceneRoot.Children.Remove(label);
        }
        _stepHighlightLabels.Clear();

   // 移除所有高亮球体
foreach (var sphere in _stepHighlightSpheres)
   {
            SceneRoot.Children.Remove(sphere);
        }
     _stepHighlightSpheres.Clear();
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"清除步骤高亮失败: {ex.Message}");
    }
}
```

---

## ?? 效果预览

### 未选中步骤

```
3D 视图:
 ・───・───・───・───・   ← 所有 USV 的点
(无高亮，无标签)
```

### 选中 Step 1

```
3D 视图:
 ?usv_01    ← 黄色高亮 + 标签
 ?usv_02    ← 黄色高亮 + 标签
 ・───・───・   ← 其他步骤的点（正常）
```

### 选中 Step 2

```
3D 视图:
 ・   ?usv_01   ← 黄色高亮 + 标签
 ・   ?usv_02   ← 黄色高亮 + 标签
     ・───・      ← 其他步骤的点
```

---

## ?? 数据流

```
用户点击 TreeView 中的 Step 1
    ↓
OnStepSelected() 触发
    ↓
_viewModel.SelectedStep = step
    ↓
PropertyChanged 事件触发
    ↓
ViewModel_PropertyChanged()
    ↓
RefreshPathEditor3D()
    ↓
pathEditor3D.HighlightStep(1, ["usv_01", "usv_02"])
    ↓
遍历所有 USV
    ├─→ usv_01 在 Step 1 的点
    │      ├─→ 创建黄色高亮球体
    │      └─→ 创建 "usv_01" 标签
    └─→ usv_02 在 Step 1 的点
           ├─→ 创建黄色高亮球体
           └─→ 创建 "usv_02" 标签
    ↓
3D 视图显示高亮点和标签
```

---

## ?? 实现步骤

### 步骤 1: 恢复 PathEditor3D.xaml.cs

```bash
# 从 Git 恢复（如果有历史版本）
git checkout HEAD -- Views/PathEditor3D.xaml.cs

# 或者从备份恢复
# 或者提供完整的文件
```

### 步骤 2: 添加字段

在 `PathEditor3D.xaml.cs` 类开头添加：

```csharp
private readonly List<BillboardTextVisual3D> _stepHighlightLabels = new();
private readonly List<SphereVisual3D> _stepHighlightSpheres = new();
```

### 步骤 3: 添加方法

在 `PathEditor3D.xaml.cs` 中添加：
- `HighlightStep(int stepNumber, List<string> usvIds)`
- `ClearStepHighlight()`

### 步骤 4: 测试

1. 运行程序
2. 导入 STEP 文件
3. 放样曲线
4. 生成步骤
5. 点击 TreeView 中的不同步骤
6. 观察 3D 视图中的高亮效果

---

## ? 验证清单

- [ ] PathEditor3D.xaml.cs 文件完整且可编译
- [ ] 添加了 `_stepHighlightLabels` 和 `_stepHighlightSpheres` 字段
- [ ] 实现了 `HighlightStep()` 方法
- [ ] 实现了 `ClearStepHighlight()` 方法
- [ ] MainWindow.xaml.cs 中调用了高亮方法
- [ ] 点击步骤时显示黄色高亮点
- [ ] 点击步骤时显示 USV ID 标签
- [ ] 切换步骤时高亮正确更新
- [ ] 未选择步骤时无高亮显示

---

## ?? 关键点

1. **高亮颜色**: 黄色 (`Colors.Yellow`)
2. **高亮大小**: 普通点的 1.5 倍
3. **标签背景**: 半透明黄色 (`Color.FromArgb(220, 255, 255, 0)`)
4. **标签内容**: USV 的名称（ID）
5. **自动清除**: 选择新步骤时自动清除之前的高亮

---

## ?? 下一步

1. **首先**: 恢复或提供完整的 `PathEditor3D.xaml.cs` 文件
2. **然后**: 按照上述步骤添加高亮功能
3. **最后**: 测试并验证功能

---

**当前状态**: ?? 等待 PathEditor3D.xaml.cs 文件恢复

**完成条件**: ? 选中步骤时，3D 视图中显示黄色高亮点和 USV ID 标签
