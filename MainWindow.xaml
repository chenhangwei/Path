<Window x:Class="Path.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Path"
        xmlns:views="clr-namespace:Path.Views"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <DockPanel LastChildFill="True">
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="文件">
                <MenuItem Header="打开" Command="{Binding OpenCommand}"/>
                <MenuItem Header="保存" Command="{Binding SaveCommand}"/>
                <MenuItem Header="导入" Command="{Binding ImportXmlCommand}"/>
                <MenuItem Header="导出XML" Command="{Binding ExportXmlCommand}"/>
            </MenuItem>
            <MenuItem Header="编辑">
                <MenuItem Header="添加步骤" Command="{Binding AddStepCommand}"/>
                <MenuItem Header="删除步骤" Command="{Binding RemoveStepCommand}"/>
                <Separator/>
                <MenuItem Header="上移步骤" Command="{Binding MoveStepUpCommand}"/>
                <MenuItem Header="下移步骤" Command="{Binding MoveStepDownCommand}"/>
                <Separator/>
                <MenuItem Header="添加 USV" Command="{Binding AddUsvCommand}"/>
            </MenuItem>
        </Menu>

        <!-- 新增：工具条（ToolBar）复用相同的命令 -->
        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <Button Command="{Binding OpenCommand}" Content="打开" ToolTip="打开"/>
                <Button Command="{Binding SaveCommand}" Content="保存" ToolTip="保存"/>
                <Separator/>
                <Button Command="{Binding ImportXmlCommand}" Content="导入" ToolTip="导入 XML 文件"/>
                <Button Command="{Binding ExportXmlCommand}" Content="导出XML" ToolTip="导出为 XML"/>
            </ToolBar>

            <ToolBar>
                <Button Command="{Binding AddStepCommand}" Content="添加步骤" ToolTip="添加步骤"/>
                <Button Command="{Binding RemoveStepCommand}" Content="删除步骤" ToolTip="删除当前步骤"/>
                <Separator/>
                <Button Command="{Binding MoveStepUpCommand}" Content="上移" ToolTip="上移当前步骤"/>
                <Button Command="{Binding MoveStepDownCommand}" Content="下移" ToolTip="下移当前步骤"/>
                <Separator/>
                <Button Command="{Binding AddUsvCommand}" Content="添加 USV" ToolTip="向当前步骤添加 USV"/>
            </ToolBar>
        </ToolBarTray>

        <StatusBar DockPanel.Dock="Bottom" Height="25" >
            <TextBlock Text="{Binding StatusMessage}"/>
        </StatusBar>

        <Grid >
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 已有左两列控件 -->
            <TreeView x:Name="StepTree" Grid.Column="0"  ItemsSource="{Binding Steps}" SelectedItemChanged="OnStepSelected">
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding USVs}">
                        <TextBlock Text="{Binding DisplayName}" />
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>

            <DataGrid x:Name="UsvGrid" Grid.Column="1" AutoGenerateColumns="False" ItemsSource="{Binding SelectedStep.USVs}" CanUserAddRows="False">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="编号" Binding="{Binding Id}"/>
                    <DataGridTextColumn Header="X" Binding="{Binding X, StringFormat=F3}"/>
                    <DataGridTextColumn Header="Y" Binding="{Binding Y, StringFormat=F3}"/>
                    <DataGridTextColumn Header="Yaw" Binding="{Binding Yaw, StringFormat=F3}"/>
                    <DataGridTextColumn Header="Speed" Binding="{Binding Speed, StringFormat=F3}"/>

                    <DataGridTemplateColumn Header="操作">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="移除" 
                                        Command="{Binding DataContext.RemoveUsvCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                        CommandParameter="{Binding}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <!-- 新增：第三列的画布编辑器 -->
            <Grid Grid.Column="2" Margin="6">
                <!-- 如果 PathEditor 已经存在于 Path.Views 命名空间，保持原样 -->
                <views:PathEditor x:Name="PathEditorControl" />
            </Grid>

        </Grid>
       
    </DockPanel>
</Window>
