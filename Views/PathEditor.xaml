<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="Path.Views.PathEditor"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Path.Views"
             x:Name="PathEditorControl"
             Height="Auto" Width="Auto">
	<Border BorderBrush="Gray" BorderThickness="1" Padding="6" Background="White">
		<DockPanel>
			<!-- Top controls -->
			<Grid DockPanel.Dock="Top" Margin="0,0,0,6" VerticalAlignment="Center">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition Width="20" />
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition Width="*" />
				</Grid.ColumnDefinitions>

				<TextBlock Grid.Column="0" VerticalAlignment="Center" Margin="0,0,6,0">画线模式:</TextBlock>
				<StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
					<RadioButton x:Name="RbPolyline" Content="折线" IsChecked="True" Margin="0,0,8,0"/>
					<RadioButton x:Name="RbArc" Content="圆弧" IsEnabled="True" ToolTip="Arc input supported"/>
				</StackPanel>

                <TextBlock Grid.Column="3" VerticalAlignment="Center" Margin="8,0,6,0">取样点数:</TextBlock>
				<TextBox Grid.Column="4" x:Name="TbSpacing" Width="60" Text="1.0" VerticalAlignment="Center" />

				<StackPanel Grid.Column="5" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
					<!-- Minimum acceptable spacing threshold (display units) -->
					<StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
						<TextBlock VerticalAlignment="Center" Margin="0,0,6,0">长度阈值:</TextBlock>
						<TextBox x:Name="TbMinSpacing" Width="60" Text="2.0" VerticalAlignment="Center" ToolTip="Minimum acceptable spacing (display units)" />
					</StackPanel>

					<Button x:Name="BtnNewUsv" Content="新USV" Margin="0,0,8,0" Click="BtnNewUsv_Click"/>
					<Button x:Name="BtnClear" Content="清理画板" Margin="0,0,8,0" Click="BtnClear_Click"/>
					<Button x:Name="BtnConfirmSamples" Content="取样" Margin="0,0,8,0" Click="BtnConfirmSamples_Click"/>
					<Button x:Name="BtnGenerate" Content="生成" Margin="0,0,8,0" Click="BtnGenerate_Click"/>
					<Button x:Name="BtnClearSamples" Content="清除取样点" Margin="0,0,8,0" Click="BtnClearSamples_Click"/>
                    <!--<Button x:Name="BtnExportCsv" Content="Export CSV" Click="BtnExportCsv_Click"/>-->
                </StackPanel>
			</Grid>

			<Grid>
				<Grid.ColumnDefinitions>
					<!-- Give the canvas the flexible large area and keep properties panel fixed width -->
					<ColumnDefinition />
					<ColumnDefinition Width="Auto" />
				</Grid.ColumnDefinitions>

				<!-- Canvas area with transforms for zoom and origin flip -->
				<Border Grid.Column="0" Background="#FFF8F8F8" BorderBrush="LightGray" BorderThickness="1">
					<ScrollViewer x:Name="CanvasScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
						<Grid Width="2000" Height="2000">
							<Canvas x:Name="DrawCanvas" Background="#FFF8F8F8"
                                      MouseLeftButtonDown="DrawCanvas_MouseLeftButtonDown"
                                      MouseLeftButtonUp="DrawCanvas_MouseLeftButtonUp"
                                      MouseMove="DrawCanvas_MouseMove"
                                      MouseDown="DrawCanvas_MouseDown"
                                      MouseUp="DrawCanvas_MouseUp"
                                      SizeChanged="DrawCanvas_SizeChanged"
                                      HorizontalAlignment="Left" VerticalAlignment="Top"
                                      Width="2000" Height="2000" />
							<Canvas x:Name="OverlayCanvas" IsHitTestVisible="True" HorizontalAlignment="Left" VerticalAlignment="Top" Width="2000" Height="2000" />
						</Grid>
					</ScrollViewer>
				</Border>

				<!-- Properties panel -->
				<StackPanel Grid.Column="1" Margin="8,0,0,0">
					<TextBlock FontWeight="Bold" Text="Selected Line Properties" Margin="0,0,0,8"/>
					<StackPanel Orientation="Horizontal" Margin="0,0,0,6">
						<TextBlock Width="60" VerticalAlignment="Center">Name:</TextBlock>
						<TextBox x:Name="TbUsvName" Width="130" TextChanged="TbUsvName_TextChanged"/>
					</StackPanel>
					<StackPanel Orientation="Horizontal" Margin="0,0,0,6">
						<TextBlock Width="60" VerticalAlignment="Center">Color:</TextBlock>
						<ComboBox x:Name="CbColor" Width="130" SelectionChanged="CbColor_SelectionChanged">
							<ComboBoxItem Content="SteelBlue"/>
							<ComboBoxItem Content="Orange"/>
							<ComboBoxItem Content="Green"/>
							<ComboBoxItem Content="Purple"/>
							<ComboBoxItem Content="Brown"/>
							<ComboBoxItem Content="Teal"/>
							<ComboBoxItem Content="Magenta"/>
							<ComboBoxItem Content="Gold"/>
						</ComboBox>
					</StackPanel>

					<TextBlock Margin="0,8,0,4">Property hint (click a line to view)</TextBlock>
					<TextBlock x:Name="TbProp" TextWrapping="Wrap"/>

					<TextBlock Margin="0,12,0,4" FontWeight="Bold">Tips</TextBlock>
					<TextBlock FontSize="11" Foreground="Gray">MinGap 单位与显示单位一致（当前显示单位乘数 _displayUnitScale）</TextBlock>
				</StackPanel>
			</Grid>

			<!-- overlay to show points/segments (kept for original markers) -->
			<ItemsControl x:Name="PointMarkers" IsHitTestVisible="False" Visibility="Collapsed">
				<ItemsControl.ItemsPanel>
					<ItemsPanelTemplate>
						<Canvas />
					</ItemsPanelTemplate>
				</ItemsControl.ItemsPanel>
				<ItemsControl.ItemTemplate>
					<DataTemplate>
						<Ellipse Width="6" Height="6" Fill="Red" Stroke="Black" StrokeThickness="1"
                                 Canvas.Left="{Binding X, Mode=OneWay}" Canvas.Top="{Binding Y, Mode=OneWay}" />
					</DataTemplate>
				</ItemsControl.ItemTemplate>
			</ItemsControl>
		</DockPanel>
	</Border>
</UserControl>